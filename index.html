<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CRM - Registro de Vendas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family:Arial; background:#f4f6f8; color:#333; }
.container { max-width:480px; margin:auto; padding:16px; }
h1,h2{margin:0 0 10px;}
label,input,textarea,select,button{width:100%;margin:6px 0;padding:12px;font-size:16px;border-radius:8px;}
input:disabled{background:#eee;}
textarea{resize:vertical;min-height:60px;}
button{background:#1976d2;color:white;border:none;cursor:pointer;}
button:active{background:#125aa0;}
.btn-excluir{background:#e53935;}
.card{background:white;padding:14px;border-radius:12px;margin-top:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
</style>
</head>

<body>
<div class="container">

<h1>Registro de Venda</h1>

<form id="formVenda">

<h2>Pedido</h2>
<label>N¬∫ do Pedido</label>
<input id="pedido" disabled>

<label>Data do Pedido</label>
<input type="date" id="dataPedido" required>

<label>Data da Entrega</label>
<input type="date" id="dataEntrega" required>

<label><input type="checkbox" id="montagem"> Montagem</label>

<hr>

<h2>Produto</h2>

<label>Modelo do Sof√°</label>
<select id="modelo" required>
<option value="">Selecione</option>
<option>Sof√° carina bra√ßo almofadado pilow de 15</option>
<option>Sof√° carina bra√ßo almofadado pilow de 25</option>
<option>Sof√° carina bra√ßo reto pilow de 15</option>
<option>Sof√° carina bra√ßo reto pilow de 25</option>
</select>

<label>Tamanho do Sof√°</label>
<input id="tamanho" required>

<label>Cor</label>
<input id="cor" required>

<label>Valor do Sof√°</label>
<input id="valorSofa" required>

<label>Frete</label>
<input id="frete" value="0">

<label>Valor da Montagem</label>
<input id="valorMontagem" value="0">

<label>Total</label>
<input id="total" disabled>

<hr>

<h2>Pagamento</h2>
<input id="pagamento" required>

<hr>

<h2>Cliente</h2>
<input placeholder="Nome" id="nomeCliente" required>
<input placeholder="Contato" id="contato" required>

<input placeholder="CEP" id="cep" required>
<input placeholder="Rua" id="rua">
<input placeholder="N√∫mero" id="numero">
<input placeholder="Bairro" id="bairro">
<input placeholder="Munic√≠pio" id="cidade">

<button type="submit">Salvar Venda</button>
</form>

<h2>Minhas Vendas</h2>
<div id="listaVendas"></div>

<button id="btnSair">Sair</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlB4NN_lTrWv4sJ1PKp2m0YjoVADnIeHk",
  authDomain: "crm-vendas-43b6b.firebaseapp.com",
  projectId: "crm-vendas-43b6b",
  storageBucket: "crm-vendas-43b6b.appspot.com",
  messagingSenderId: "645002761099",
  appId: "1:645002761099:web:f194f70c351d1074ac158e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let vendedor = { nome:"", email:"" };

// üîê Auth
onAuthStateChanged(auth, user=>{
  if(!user) location.href="login.html";
  vendedor.nome = user.displayName;
  vendedor.email = user.email;
  carregarVendas();
});

// üö™ Logout
btnSair.onclick = async ()=>{
  await signOut(auth);
  location.href="login.html";
};

// üí∞ Moeda
function moeda(i){ let v=i.value.replace(/\D/g,""); v=(v/100).toFixed(2); v=v.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,"."); i.value="R$ "+v; totalizar(); }
function limpar(v){ return Number(v.replace(/\D/g,""))/100||0; }
function totalizar(){
  total.value=(limpar(valorSofa.value)+limpar(frete.value)+(montagem.checked?limpar(valorMontagem.value):0))
  .toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
valorSofa.oninput=()=>moeda(valorSofa);
frete.oninput=()=>moeda(frete);
valorMontagem.oninput=()=>moeda(valorMontagem);
montagem.onchange=totalizar;

// üìç CEP
cep.onblur=async()=>{
  const c=cep.value.replace(/\D/g,"");
  if(c.length!==8) return;
  const r=await fetch(`https://viacep.com.br/ws/${c}/json/`).then(r=>r.json());
  if(!r.erro){
    rua.value=r.logradouro;
    bairro.value=r.bairro;
    cidade.value=r.localidade;
  }
};

// üíæ Salvar
formVenda.onsubmit=async e=>{
  e.preventDefault();
  await addDoc(collection(db,"vendas"),{
    vendedorNome:vendedor.nome,
    vendedorEmail:vendedor.email,
    pedido:Date.now(),
    dataPedido:dataPedido.value,
    dataEntrega:dataEntrega.value,
    produto:{
      modelo:modelo.value,
      tamanho:tamanho.value,
      cor:cor.value,
      total:limpar(total.value)
    },
    pagamento:pagamento.value,
    cliente:{
      nome:nomeCliente.value,
      contato:contato.value,
      cep:cep.value,
      rua:rua.value,
      numero:numero.value,
      bairro:bairro.value,
      cidade:cidade.value
    }
  });
  formVenda.reset();
  carregarVendas();
};

// üìÑ Listar
async function carregarVendas(){
  listaVendas.innerHTML="";
  const q=query(collection(db,"vendas"),where("vendedorEmail","==",vendedor.email));
  const s=await getDocs(q);
  s.forEach(d=>{
    const v=d.data();
    listaVendas.innerHTML+=`
      <div class="card">
        <b>${v.produto.modelo}</b><br>
        Cliente: ${v.cliente.nome}<br>
        Total: R$ ${v.produto.total.toFixed(2)}<br>
        <button class="btn-excluir" onclick="excluir('${d.id}')">Excluir</button>
      </div>`;
  });
}

// üóëÔ∏è Excluir com motivo
window.excluir=async id=>{
  if(!confirm("Deseja realmente excluir essa venda?")) return;
  const motivo=prompt("Informe o motivo da exclus√£o:");
  if(!motivo) return;
  await deleteDoc(doc(db,"vendas",id));
  carregarVendas();
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CRM - Registro de Vendas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:Arial; background:#f4f6f8; color:#333; }
.container { max-width:480px; margin:auto; padding:16px; }
h1,h2{margin:0 0 10px;}
label,input,textarea,select,button{width:100%;margin:6px 0;padding:12px;font-size:16px;border-radius:8px;}
input:disabled{background:#eee;}
textarea{resize:vertical;min-height:80px;}
button{background:#1976d2;color:white;border:none;cursor:pointer;}
button:active{background:#125aa0;}
.card{background:white;padding:14px;border-radius:12px;margin-top:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
.btn-excluir{background:#e53935;}
.btn-excluir:active{background:#c62828;}
.sucesso{
  background:#c8e6c9;
  color:#1b5e20;
  padding:10px;
  border-radius:8px;
  margin-top:10px;
  text-align:center;
  display:none;
}
</style>
</head>

<body>
<div class="container">
<h1>Registro de Venda</h1>

<div id="msgSucesso" class="sucesso">Venda salva com sucesso ✅</div>

<form id="formVenda">

<h2>Dados do Pedido</h2>
<label>Nº do Pedido</label>
<input type="text" id="pedido" disabled>

<label>Data do Pedido</label>
<input type="date" id="dataPedido" required>

<label>Data da Entrega</label>
<input type="date" id="dataEntrega" required>

<div>
  <input type="checkbox" id="montagem">
  <label for="montagem">Montagem</label>
</div>

<hr>

<h2>Produto</h2>

<label>Modelo do Sofá</label>
<select id="modelo" required>
  <option value="">Selecione o modelo</option>
  <option>Sofá carina braço almofadado pilow de 15</option>
  <option>Sofá carina braço almofadado pilow de 25</option>
  <option>Sofá carina braço reto pilow de 15</option>
  <option>Sofá carina braço reto pilow de 25</option>
</select>

<label>Tamanho do Sofá</label>
<input type="text" id="tamanhoSofa" placeholder="Ex: 2,30m" required>

<label>Cor</label>
<input type="text" id="cor" required>

<label>Valor do Sofá</label>
<input type="text" id="valorSofa" required>

<label>Frete</label>
<input type="text" id="frete" value="0">

<label>Valor da Montagem</label>
<input type="text" id="valorMontagem" value="0">

<label>Total</label>
<input type="text" id="total" disabled>

<hr>

<h2>Pagamento</h2>
<label>Forma de Pagamento</label>
<input type="text" id="pagamento" required>

<hr>

<h2>Cliente</h2>
<label>Nome</label>
<input type="text" id="nomeCliente" required>

<label>Contato</label>
<input type="text" id="contato" required>

<label>CEP</label>
<input type="text" id="cep" required>

<label>Rua</label>
<input type="text" id="rua">

<label>Número</label>
<input type="text" id="numero">

<label>Bairro</label>
<input type="text" id="bairro">

<label>Município</label>
<input type="text" id="municipio" value="São Paulo">

<hr>

<h2>Vendedora</h2>
<select id="vendedora"></select>

<button type="submit">Salvar Venda</button>
</form>

<h2>Vendas registradas</h2>
<div id="listaVendas"></div>

<button id="btnSair">Sair</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlB4NN_lTrWv4sJ1PKp2m0YjoVADnIeHk",
  authDomain: "crm-vendas-43b6b.firebaseapp.com",
  projectId: "crm-vendas-43b6b",
  storageBucket: "crm-vendas-43b6b.appspot.com",
  messagingSenderId: "645002761099",
  appId: "1:645002761099:web:f194f70c351d1074ac158e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userVendedora = { email: "" };

onAuthStateChanged(auth, async (user) => {
  if (!user) window.location.href = "login.html";
  userVendedora.email = user.email;
  vendedora.innerHTML = `<option>${user.email}</option>`;
  await carregarVendas();
});

btnSair.onclick = async ()=>{
  await signOut(auth);
  window.location.href="login.html";
};

function formatarMoeda(input){
  let v=input.value.replace(/\D/g,"");
  v=(Number(v)/100).toFixed(2);
  input.value="R$ "+v.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

function limparMoeda(v){
  return Number(v.replace("R$","").replace(/\./g,"").replace(",",".").trim())||0;
}

function calcularTotal(){
  const v=limparMoeda(valorSofa.value);
  const f=limparMoeda(frete.value);
  const m=montagem.checked?limparMoeda(valorMontagem.value):0;
  total.value=(v+f+m).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

valorSofa.oninput=()=>{formatarMoeda(valorSofa);calcularTotal();}
frete.oninput=()=>{formatarMoeda(frete);calcularTotal();}
valorMontagem.oninput=()=>{formatarMoeda(valorMontagem);calcularTotal();}
montagem.onchange=calcularTotal;

cep.onblur=async ()=>{
  const c=cep.value.replace(/\D/g,'');
  if(c.length!==8) return;
  const r=await fetch(`https://viacep.com.br/ws/${c}/json/`);
  const d=await r.json();
  if(d.erro) return;
  rua.value=d.logradouro;
  bairro.value=d.bairro;
  municipio.value=d.localidade || "São Paulo";
};

formVenda.onsubmit=async e=>{
  e.preventDefault();

  await addDoc(collection(db,"vendas"),{
    vendedora:userVendedora.email,
    pedido:Date.now(),
    dataPedido:dataPedido.value,
    dataEntrega:dataEntrega.value,
    produto:{
      modelo:modelo.value,
      tamanho:tamanhoSofa.value,
      cor:cor.value,
      valor:limparMoeda(valorSofa.value),
      frete:limparMoeda(frete.value),
      montagem:montagem.checked?limparMoeda(valorMontagem.value):0,
      total:limparMoeda(total.value)
    },
    pagamento:pagamento.value,
    cliente:{
      nome:nomeCliente.value,
      contato:contato.value,
      cep:cep.value,
      rua:rua.value,
      numero:numero.value,
      bairro:bairro.value,
      municipio:municipio.value
    },
    criadoEm:new Date()
  });

  formVenda.reset();
  calcularTotal();
  msgSucesso.style.display="block";
  setTimeout(()=>msgSucesso.style.display="none",3000);

  await carregarVendas();
  listaVendas.scrollIntoView({behavior:"smooth"});
};

async function carregarVendas(){
  listaVendas.innerHTML="";
  const q=query(collection(db,"vendas"),where("vendedora","==",userVendedora.email));
  const s=await getDocs(q);
  s.forEach(d=>{
    const v=d.data();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h3>Pedido Nº ${v.pedido}</h3>
      <p><strong>Cliente:</strong> ${v.cliente.nome}</p>
      <p><strong>Modelo:</strong> ${v.produto.modelo}</p>
      <p><strong>Total:</strong> ${v.produto.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</p>
      <button class="btn-excluir" onclick="excluirVenda('${d.id}')">Excluir</button>
    `;
    listaVendas.appendChild(div);
  });
}

window.excluirVenda=async id=>{
  if(!confirm("Você deseja realmente excluir essa venda?")) return;
  const motivo=prompt("Informe o motivo da exclusão:");
  if(!motivo) return alert("Motivo obrigatório");
  await deleteDoc(doc(db,"vendas",id));
  await carregarVendas();
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CRM - Registro de Vendas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f4f6f8}
.container{max-width:1100px;margin:auto;padding:16px;display:grid;gap:24px}
@media(min-width:768px){.container{grid-template-columns:1fr 1fr}}

form,#listaVendas{background:white;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
label{font-weight:bold;display:block;margin-top:12px}
input,textarea,select{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
textarea{min-height:70px}
button{margin-top:20px;width:100%;padding:14px;background:#1976d2;color:white;border:none;border-radius:10px;font-size:16px}
.card{background:#fafafa;padding:12px;border-radius:10px;margin-top:10px}
.btn-excluir{background:#e53935;margin-top:10px}
</style>
</head>

<body>

<div class="container">

<form id="formVenda">
<h2>Registro de Venda</h2>

<label>NÂº do Pedido</label>
<input id="pedido" disabled>

<label>Data do Pedido</label>
<input type="date" id="dataPedido" required>

<label>Data da Entrega</label>
<input type="date" id="dataEntrega" required>

<label>Modelo do SofÃ¡</label>
<textarea id="modelo" required></textarea>

<label>Cor</label>
<input id="cor" required>

<label>Valor do SofÃ¡</label>
<input id="valorSofa" required>

<label>Frete</label>
<input id="frete">

<label>Montagem</label>
<input type="checkbox" id="montagem">

<label>Valor Montagem</label>
<input id="valorMontagem">

<label>Total</label>
<input id="total" disabled>

<label>Cliente</label>
<input id="nomeCliente" required>

<button type="submit">Salvar Venda</button>
</form>

<div>
<h2>Minhas Vendas</h2>
<div id="listaVendas"></div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBlBNN_lTrWv4sJ1PKp2m0YjoVADnIeHk",
  authDomain: "crm-vendas-43b6b.firebaseapp.com",
  projectId: "crm-vendas-43b6b"
});

const auth = firebase.auth();

/* ===============================
   ðŸ” CONTROLE DE ACESSO CORRETO
================================ */
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // UsuÃ¡rio autenticado
  iniciarSistema(user);
});

/* ===============================
   ðŸš€ SISTEMA DE VENDAS
================================ */
function iniciarSistema(user) {

  const form = document.getElementById("formVenda");
  const lista = document.getElementById("listaVendas");

  let vendas = JSON.parse(localStorage.getItem("vendas")) || [];

  function gerarNumeroPedido() {
    const proximo = (Number(localStorage.getItem("ultimoPedido")) || 0) + 1;
    document.getElementById("pedido").value = proximo;
  }

  function calcularTotal() {
    const valor = limparMoeda(valorSofa.value);
    const freteValor = limparMoeda(frete.value);
    const montagemValor = montagem.checked ? limparMoeda(valorMontagem.value) : 0;
    const soma = valor + freteValor + montagemValor;

    total.value = soma.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });
  }

  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const numeroPedido =
      (Number(localStorage.getItem("ultimoPedido")) || 0) + 1;

    localStorage.setItem("ultimoPedido", numeroPedido);

    const venda = {
      pedido: numeroPedido,
      vendedorEmail: user.email, // ðŸ”¥ CHAVE DO CONTROLE
      dataPedido: dataPedido.value,
      dataEntrega: dataEntrega.value,
      montagem: montagem.checked,
      produto: {
        modelo: modelo.value,
        cor: cor.value,
        valor: limparMoeda(valorSofa.value),
        frete: limparMoeda(frete.value),
        valorMontagem: montagem.checked ? limparMoeda(valorMontagem.value) : 0,
        total: limparMoeda(total.value)
      },
      pagamento: pagamento.value,
      cliente: {
        nome: nomeCliente.value,
        contato: contato.value,
        cep: cep.value,
        rua: rua.value,
        numero: numero.value,
        cidade: cidade.value,
        bairro: bairro.value
      }
    };

    vendas.push(venda);
    localStorage.setItem("vendas", JSON.stringify(vendas));

    form.reset();
    gerarNumeroPedido();
    renderizarVendas();
  });

  function renderizarVendas() {
    lista.innerHTML = "";

    vendas
      .filter(v => v.vendedorEmail === user.email)
      .forEach(venda => {
        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
          <h3>Pedido NÂº ${venda.pedido}</h3>
          <p><strong>Cliente:</strong> ${venda.cliente.nome}</p>
          <p><strong>Total:</strong> R$ ${venda.produto.total.toFixed(2)}</p>
        `;

        lista.appendChild(div);
      });
  }

  gerarNumeroPedido();
  renderizarVendas();
}
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CRM - Registro de Vendas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:Arial; background:#f4f6f8; color:#333; }
.container { max-width:480px; margin:auto; padding:16px; }
h1,h2{margin:0 0 10px;}
label,input,textarea,select,button{width:100%;margin:6px 0;padding:12px;font-size:16px;border-radius:8px;}
input:disabled{background:#eee;}
textarea{resize:vertical;min-height:80px;}
button{background:#1976d2;color:white;border:none;cursor:pointer;}
button:active{background:#125aa0;}
.btn-excluir{background:#e53935;}
.btn-excluir:active{background:#c62828;}
.card{background:white;padding:14px;border-radius:12px;margin-top:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
</style>
</head>
<body>
<div class="container">
<h1>Registro de Venda</h1>
<form id="formVenda">
<h2>Dados do Pedido</h2>
<label>Nº do Pedido</label><input type="text" id="pedido" disabled>
<label>Data do Pedido</label><input type="date" id="dataPedido" required>
<label>Data da Entrega</label><input type="date" id="dataEntrega" required>
<div><input type="checkbox" id="montagem"><label for="montagem">Montagem</label></div>
<hr>
<h2>Produto</h2>
<label>Modelo do Sofá</label><textarea id="modelo" required></textarea>
<label>Cor</label><input type="text" id="cor" required>
<label>Valor do Sofá</label><input type="text" id="valorSofa" required>
<label>Frete</label><input type="text" id="frete" value="0">
<label>Valor da Montagem</label><input type="text" id="valorMontagem" value="0">
<label>Total</label><input type="text" id="total" disabled>
<hr>
<h2>Pagamento</h2>
<label>Forma de Pagamento</label><input type="text" id="pagamento" required>
<hr>
<h2>Cliente</h2>
<label>Nome</label><input type="text" id="nomeCliente" required>
<label>Contato</label><input type="text" id="contato" required>
<label>CEP</label><input type="text" id="cep" required>
<label>Rua</label><input type="text" id="rua">
<label>Número</label><input type="text" id="numero">
<label>Cidade</label><input type="text" id="cidade" value="São Paulo" disabled>
<label>Bairro</label><input type="text" id="bairro">
<hr>
<h2>Vendedora</h2>
<select id="vendedora"></select>
<button type="submit">Salvar Venda</button>
</form>

<h2>Vendas registradas</h2>
<div id="listaVendas"></div>
<button id="btnSair">Sair</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlB4NN_lTrWv4sJ1PKp2m0YjoVADnIeHk",
  authDomain: "crm-vendas-43b6b.firebaseapp.com",
  projectId: "crm-vendas-43b6b",
  storageBucket: "crm-vendas-43b6b.appspot.com",
  messagingSenderId: "645002761099",
  appId: "1:645002761099:web:f194f70c351d1074ac158e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userVendedora = { email: "" };

// Autenticação
onAuthStateChanged(auth, async (user) => {
    if (!user) window.location.href = "login.html";
    userVendedora.email = user.email;
    document.getElementById("vendedora").innerHTML = `<option>${user.email}</option>`;
    await carregarVendas();
});

// Logout
document.getElementById("btnSair").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
});

// Funções de moeda e total
function formatarMoeda(input){ let v=input.value.replace(/\D/g,""); v=(Number(v)/100).toFixed(2); v=v.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,"."); input.value="R$ "+v; }
function limparMoeda(valor){ return Number(valor.replace("R$","").replace(/\./g,"").replace(",",".").trim())||0; }
function calcularTotal(){ 
    const v = limparMoeda(valorSofa.value), f = limparMoeda(frete.value), m = montagem.checked?limparMoeda(valorMontagem.value):0;
    total.value = (v+f+m).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
valorSofa.oninput=()=>{formatarMoeda(valorSofa); calcularTotal();}
frete.oninput=()=>{formatarMoeda(frete); calcularTotal();}
valorMontagem.oninput=()=>{formatarMoeda(valorMontagem); calcularTotal();}
montagem.onchange=calcularTotal;

// Função CEP automático
cep.addEventListener("blur", async ()=>{
    const cepValor = cep.value.replace(/\D/g,'');
    if(cepValor.length!==8) { alert("CEP inválido"); return; }
    const res = await fetch(`https://viacep.com.br/ws/${cepValor}/json/`);
    const data = await res.json();
    if(data.erro){ alert("CEP não encontrado"); return; }
    rua.value = data.logradouro;
    bairro.value = data.bairro;
});

// Salvar venda no Firestore
formVenda.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const docRef = await addDoc(collection(db,"vendas"),{
        vendedora: userVendedora.email,
        pedido: Date.now(),
        dataPedido: dataPedido.value,
        dataEntrega: dataEntrega.value,
        montagem: montagem.checked,
        produto: {
            modelo: modelo.value,
            cor: cor.value,
            valor: limparMoeda(valorSofa.value),
            frete: limparMoeda(frete.value),
            valorMontagem: montagem.checked?limparMoeda(valorMontagem.value):0,
            total: limparMoeda(total.value)
        },
        pagamento: pagamento.value,
        cliente:{
            nome:nomeCliente.value,
            contato:contato.value,
            cep:cep.value,
            rua:rua.value,
            numero:numero.value,
            cidade:cidade.value,
            bairro:bairro.value
        }
    });
    formVenda.reset();
    calcularTotal();
    carregarVendas();
});

// Carregar vendas do usuário logado
async function carregarVendas(){
    listaVendas.innerHTML="";
    const q = query(collection(db,"vendas"), where("vendedora","==",userVendedora.email));
    const querySnapshot = await getDocs(q);
    querySnapshot.forEach(docu=>{
        const v = docu.data();
        const div = document.createElement("div");
        div.className="card";
        div.innerHTML=`
            <h3>Pedido Nº ${v.pedido}</h3>
            <p><strong>Cliente:</strong> ${v.cliente.nome}</p>
            <p><strong>Produto:</strong> ${v.produto.modelo}</p>
            <p><strong>Total:</strong> R$ ${v.produto.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</p>
            <button onclick="excluirVenda('${docu.id}')">Excluir</button>
        `;
        listaVendas.appendChild(div);
    });
}

// Excluir venda
window.excluirVenda = async (id)=>{
    if(confirm("Deseja excluir este pedido?")){
        await deleteDoc(doc(db,"vendas",id));
        carregarVendas();
    }
};
</script>
</body>
</html>

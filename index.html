<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CRM - Registro de Vendas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ===== ESTILOS ===== */
body { margin:0; font-family:Arial; background:#f4f6f8; color:#333; }
.container { max-width:480px; margin:auto; padding:16px; }
h1,h2{margin:0 0 10px;}
label,input,textarea,select,button{width:100%;margin:6px 0;padding:12px;font-size:16px;border-radius:8px;}
input:disabled{background:#eee;}
textarea{resize:vertical;min-height:80px;}
button{background:#1976d2;color:white;border:none;cursor:pointer;}
button:active{background:#125aa0;}
.btn-excluir{background:#e53935;}
.btn-excluir:active{background:#c62828;}
.card{background:white;padding:14px;border-radius:12px;margin-top:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
@media(min-width:768px){.container{max-width:1100px;display:grid;grid-template-columns:1fr 1fr;gap:24px;padding:24px;}form{background:white;padding:24px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);}#listaVendas{background:white;padding:24px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);max-height:calc(100vh-80px);overflow-y:auto;}button{font-size:16px;}}
</style>
</head>
<body>
<div class="container">
<h1>Registro de Venda</h1>
<form id="formVenda">
<h2>Dados do Pedido</h2>
<label>Nº do Pedido</label><input type="text" id="pedido" disabled>
<label>Data do Pedido</label><input type="date" id="dataPedido" required>
<label>Data da Entrega</label><input type="date" id="dataEntrega" required>
<div><input type="checkbox" id="montagem"><label for="montagem">Montagem</label></div>
<hr>
<h2>Produto</h2>
<label>Modelo do Sofá</label><textarea id="modelo" required></textarea>
<label>Cor</label><input type="text" id="cor" required>
<label>Valor do Sofá</label><input type="text" id="valorSofa" required>
<label>Frete</label><input type="text" id="frete" value="0">
<label>Valor da Montagem</label><input type="text" id="valorMontagem" value="0">
<label>Total</label><input type="text" id="total" disabled>
<hr>
<h2>Pagamento</h2>
<label>Forma de Pagamento</label><input type="text" id="pagamento" required>
<hr>
<h2>Cliente</h2>
<label>Nome</label><input type="text" id="nomeCliente" required>
<label>Contato</label><input type="text" id="contato" required>
<label>CEP</label><input type="text" id="cep">
<label>Rua</label><input type="text" id="rua">
<label>Número</label><input type="text" id="numero">
<label>Cidade</label><input type="text" id="cidade">
<label>Bairro</label><input type="text" id="bairro">
<hr>
<h2>Vendedora</h2>
<select id="vendedora"><option>Débora</option><option>Ana</option><option>Paula</option></select>
<button type="submit">Salvar Venda</button>
</form>

<div>
<h2>Vendas registradas</h2>
<div id="listaVendas"></div>
<button id="btnSair">Sair</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlB4NN_lTrWv4sJ1PKp2m0YjoVADnIeHk",
  authDomain: "crm-vendas-43b6b.firebaseapp.com",
  projectId: "crm-vendas-43b6b",
  storageBucket: "crm-vendas-43b6b.firebasestorage.app",
  messagingSenderId: "645002761099",
  appId: "1:645002761099:web:f194f70c351d1074ac158e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Verifica usuário logado
onAuthStateChanged(auth, (user) => {
    if (!user) window.location.href = "login.html";
});

// Logout
document.getElementById("btnSair").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
});

// ==== SEU SCRIPT DE VENDAS ====

const form = document.getElementById("formVenda");
const lista = document.getElementById("listaVendas");
let vendas = JSON.parse(localStorage.getItem("vendas")) || [];

// Número do pedido automático
function gerarNumeroPedido() {
    const proximo = (Number(localStorage.getItem("ultimoPedido"))||0)+1;
    document.getElementById("pedido").value = proximo;
}

// Formata moeda
function formatarMoeda(input){
    let valor = input.value.replace(/\D/g,"");
    valor = (Number(valor)/100).toFixed(2);
    valor = valor.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");
    input.value="R$ "+valor;
}
function limparMoeda(valor){
    return Number(valor.replace("R$","").replace(/\./g,"").replace(",",".").trim())||0;
}

// Calcula total
function calcularTotal(){
    const valor = limparMoeda(valorSofa.value);
    const freteValor = limparMoeda(frete.value);
    const montagemValor = montagem.checked ? limparMoeda(valorMontagem.value) : 0;
    total.value = (valor+freteValor+montagemValor).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
valorSofa.oninput=()=>{formatarMoeda(valorSofa); calcularTotal();}
frete.oninput=()=>{formatarMoeda(frete); calcularTotal();}
valorMontagem.oninput=()=>{formatarMoeda(valorMontagem); calcularTotal();}
montagem.onchange=calcularTotal;

// Salvar venda
form.addEventListener("submit",function(e){
    e.preventDefault();
    const numeroPedido = (Number(localStorage.getItem("ultimoPedido"))||0)+1;
    localStorage.setItem("ultimoPedido",numeroPedido);

    const venda = {
        pedido: numeroPedido,
        dataPedido: dataPedido.value,
        dataEntrega: dataEntrega.value,
        montagem: montagem.checked,
        produto:{
            modelo:modelo.value,
            cor:cor.value,
            valor:limparMoeda(valorSofa.value),
            frete:limparMoeda(frete.value),
            valorMontagem: montagem.checked ? limparMoeda(valorMontagem.value):0,
            total:limparMoeda(total.value)
        },
        pagamento: pagamento.value,
        cliente:{
            nome:nomeCliente.value,
            contato:contato.value,
            cep:cep.value,
            rua:rua.value,
            numero:numero.value,
            cidade:cidade.value,
            bairro:bairro.value
        },
        vendedora:vendedora.value
    };

    vendas.push(venda);
    localStorage.setItem("vendas",JSON.stringify(vendas));
    form.reset();
    gerarNumeroPedido();
    renderizarVendas();
});

// Renderizar vendas
function renderizarVendas(){
    lista.innerHTML="";
    vendas.forEach(v=>{
        const div=document.createElement("div");
        div.className="card";
        div.innerHTML=`
            <h3>Pedido Nº ${v.pedido}</h3>
            <p><strong>Cliente:</strong> ${v.cliente.nome}</p>
            <p><strong>Produto:</strong> ${v.produto.modelo}</p>
            <p><strong>Total:</strong> R$ ${v.produto.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</p>
            <p><strong>Vendedora:</strong> ${v.vendedora}</p>
            <button class="btn-excluir" onclick="excluirPedido(${v.pedido})">Excluir</button>
        `;
        lista.appendChild(div);
    });
}

function excluirPedido(pedido){
    if(!confirm("Deseja excluir este pedido?")) return;
    vendas=vendas.filter(v=>Number(v.pedido)!==Number(pedido));
    localStorage.setItem("vendas",JSON.stringify(vendas));
    renderizarVendas();
}

gerarNumeroPedido();
renderizarVendas();

</script>
</body>
</html>
